MERGE INTO INTEGRATED.CUSTOMER_INTEGRATED TGT
USING (
    SELECT  
        CUSTOMER_ID,
        CUSTOMER_NAME,
        COALESCE(
            TRY_TO_DATE(DOB, 'YYYY-MM-DD'),
            TRY_TO_DATE(DOB, 'DD-MM-YYYY')
        ) AS FINAL_DOB,     
        PHONE,
        EMAIL,
        FILE_NAME,
        ROW_NUM,
        INSERT_DATE
        
    FROM RAW.CUSTOMER_STM
) SRC
ON SRC.CUSTOMER_ID = TGT.CUSTOMER_ID

-- Update if any change
WHEN MATCHED  
     AND MD5(CONCAT(SRC.CUSTOMER_NAME, SRC.PHONE, SRC.EMAIL, SRC.FINAL_DOB)) 
     != MD5(CONCAT(TGT.CUSTOMER_NAME, TGT.PHONE, TGT.EMAIL, TGT.DOB))
THEN UPDATE SET 
    TGT.CUSTOMER_NAME = SRC.CUSTOMER_NAME,
    TGT.DOB           = SRC.FINAL_DOB,
    TGT.PHONE         = SRC.PHONE,
    TGT.EMAIL         = SRC.EMAIL,
    TGT.FILE_NAME     = SRC.FILE_NAME,
    TGT.ROW_NUM       = SRC.ROW_NUM,
    TGT.UPDATE_DATE   = CURRENT_DATE

-- Insert if new
WHEN NOT MATCHED THEN
  INSERT (
    CUSTOMER_ID,
    CUSTOMER_NAME,
    DOB,
    PHONE,
    EMAIL,
    FILE_NAME,
    ROW_NUM,
    INSERT_DATE,
    UPDATE_DATE
  )
  VALUES (
    SRC.CUSTOMER_ID,
    SRC.CUSTOMER_NAME,
    SRC.FINAL_DOB,
    SRC.PHONE,
    SRC.EMAIL,
    SRC.FILE_NAME,
    SRC.ROW_NUM,
    SRC.INSERT_DATE,
    SRC.UPDATE_DATE
  )